---
title: "Grammatical Category Analysis"
author: "Dan Yurovsky, Mika Braginsky, & Mike Frank (in no particular order)"
date: "December 20, 2014"
output: html_document
---

Load required Libraries
```{r, message=FALSE}
rm(list=ls())
library(ggplot2)
library(dplyr)
library(tidyr)
library(RMySQL)
library(stringr)
library(magrittr)
library(pcaPP)
library(directlabels)
```

Load in Wordbank tata
```{r}
## OPEN DATABASE CONNECTION ##
wordbank <- src_mysql(dbname='wordbank',host="54.149.39.46",
                      user="wordbank",password="wordbank")
#wordbank <- src_mysql(dbname='wordbank',host="54.200.225.86",
#                      user="wordbank",password="wordbank")

## NOW LOAD TABLES ##
admin.table <- tbl(wordbank,"common_administration")
child.table <- tbl(wordbank,"common_child")
wordmapping.table <- tbl(wordbank,"common_wordmapping")
instruments.table <- tbl(wordbank,"common_instrumentsmap")
english.ws.table <- tbl(wordbank,"instruments_english_ws")
norwegian.ws.table <- tbl(wordbank,"instruments_norwegian_ws")
danish.ws.table <- tbl(wordbank,"instruments_danish_ws")
```

Ad-hoc fix to norwegians.
```{r}
norwegian.ws.table[is.na(norwegian.ws.table)] = ""
danish.ws.table[is.na(danish.ws.table)] = ""
```

Get kid data and put together. 
```{r, message=FALSE}
# Get administration info
admins <- admin.table %>%
  select(data_id,child_id,age,source_id) %>%
  rename(id = data_id, child.id = child_id, source.id = source_id) 
admins <- as.data.frame(admins)

# Get demographic variables for each child
demos <- select(child.table,id,sex,mom_ed,birth_order) %>%
  rename(child.id = id) # Rename id fields
demos <- as.data.frame(demos)

# Join age and demographics together
child.data <- as.tbl(left_join(admins,demos))
```

Set up mappings and instruments. 

```{r, message=FALSE}
mapping <- as.data.frame(wordmapping.table)
instruments <- as.data.frame(instruments.table) %>%
  rename(instrument_id = id)
items <- left_join(mapping, instruments)
```

Pull data out of the wordbank tables, in a functional way. 
```{r,message=FALSE}
aggregate.wordbank <- function(lang.table, lang.items, lang) {
  
  instrument.items <- lang.items %>% filter(language == lang, 
                                               form == 'WS') %>%
    select(item, type, category, lexical_category)
  
  instrument.data <- as.data.frame(lang.table) %>%
    rename(id = basetable_ptr_id) %>% # Rename the id
    gather(item, value,-id) %>% # Arrange in longform
    mutate(item = str_replace(item, "item_", "")) # Strip off item_ 
  
  d <- left_join(instrument.data, instrument.items)
  
  d.vocab <- d %>%
    filter(type == "word") %>%
    group_by(id) %>%
    summarise(vocab = sum(value == "produces", na.rm=TRUE))
  
  d.syntax <- d %>%
    filter(type == "complexity") %>%
    group_by(id) %>%
    summarise(complexity = mean(value == "complex", na.rm=TRUE))
  
  d.wordform <- d %>%
    filter(type %in% c("word_form")) %>%
    group_by(id) %>%
    summarise(wordform = mean(value == "produces", na.rm=TRUE))
  
  d.ending <- d %>%
    filter(type %in% c("ending")) %>%
    group_by(id) %>%
    summarise(ending_sometimes = mean(value == "sometimes" | 
                                        value == "often", 
                                      na.rm=TRUE), 
              ending_often = mean(value == "often", 
                                  na.rm=TRUE))
  
  d.composite <- left_join(d.vocab, d.syntax)
  d.composite <- left_join(d.composite, d.wordform)
  d.composite <- left_join(d.composite, d.ending)
  
  d.composite$language <- lang 
  
  return(d.composite)
  }
```

Run that on stuff.
```{r, message=FALSE}
d.english <- aggregate.wordbank(lang.table=english.ws.table, 
                                lang.items=items, 
                                lang="English")
d.norwegian <- aggregate.wordbank(lang.table=norwegian.ws.table, 
                                  lang.items=items, 
                                  lang="Norwegian")
d.danish <- aggregate.wordbank(lang.table=danish.ws.table, 
                               lang.items=items, 
                               lang="Danish")
```

Now stick this all in a big data frame. 
```{r, message=FALSE}
d <- rbind_list(d.english,d.norwegian,d.danish)
d <- left_join(d, child.data) %>%
  filter(age > 15 & age < 31) %>%
  mutate(age.group = cut(age, breaks = c(15, 20, 25, 30)))
```

Moment of truth!
```{r,fig.width=11,fig.height=5}
# quartz()
# qplot(vocab, complexity, col=age.group,
#       facets=~language,
#       data=d) + 
#   geom_smooth(method="lm", formula=y ~ I(x^2)-1)
```

```{r}

#gather for plotting
ms <- d %>% gather(measure, score, syntax:morpho) %>%
 mutate(measure = factor(measure, levels = c("wordform",""),
                         labels = c("Morphology", "Syntax")),
        s.vocab = scale(vocab),
        s.age = scale(age))

# by-item morphology data for further analysis
bykid.syntax.vocab <- left_join(ws.words,ws.syntax)
bykid.syntax.vocab <- left_join(bykid.syntax.vocab,child.data) %>%
 filter(vocab > 0, age >15, age < 31) %>%
 select(-child.id,-source.id) %>% #drop redundant columns 
 mutate(age.binned = cut(age, breaks = c(15, 20, 25, 30))) %>%
 spread(word,produces)
```

Age and Vocab predict Morphology and Syntax Scores
```{r,fig.width=11,fig.height=5}
#ggplot(ms,aes(x = vocab, y = score, colour = age.binned, fill = age.binned,
#              label = age.binned)) + 
#  geom_jitter()+
#  geom_smooth(method="lm", formula = y ~ I(x^2)) + 
#  facet_wrap(~measure) + 
#  scale_x_continuous(limits = c(0,681), breaks = seq(0,680,100),name = "Vocabulary (WS)") + 
#  scale_y_continuous(limits = c(0, 1.05), breaks = seq(0,1,.2),"Score (Mean Items)") + 
#  theme_bw(base_size = 14) +
#  scale_color_brewer(palette="Set1") +
#  scale_fill_brewer(palette="Set1") 
```

Using Morphology to Predict Syntax
```{r,fig.width=7,fig.height=5}
#ggplot(d,aes(x = morpho, y = syntax, fill=age.binned,colour=age.binned,
#             label=age.binned))+ 
#  geom_jitter()+
#  geom_smooth(method="lm", formula = y ~ x) + 
#  scale_x_continuous(limits = c(0,1.05), breaks=seq(0,1,.2),name = "Morphology Score") + 
#  scale_y_continuous(limits = c(0,1.05), breaks=seq(0,1,.2),"Syntax Score") + 
#  scale_color_brewer(palette="Set1") +
#  scale_fill_brewer(palette="Set1") +
#  theme_bw(base_size = 14)
#```

#Fit regressions to data
#```{r,fig.width=12,fig.height=7.5}
#t.lm1 <- lm(score ~ age + measure, data=ms)
#t.lm2 <- lm(score ~ I(vocab^2)*measure + age*measure, data=ms)
#t.lm3 <- lm(score  ~ I(vocab^2)*measure*age.binned, data=ms)
#t.lm4 <- lm(score  ~ I(vocab^2)*measure*age, data=ms)

#ms$predicted <- predict.lm(t.lm3,ms)

# Plot by age
#ggplot(ms,aes(x = vocab, y = score, colour = measure,label=measure))+
#  facet_wrap(~ age)+
#  geom_jitter(size=1)+
#  geom_line(aes(y=predicted),size=.5)+
#  scale_color_brewer(palette="Set1") +
#  scale_x_continuous(limits = c(0,681), breaks = seq(0,680,100),name = "Vocabulary (WS)") + 
#  scale_y_continuous(limits = c(0, 1.05), breaks = seq(0,1,.2),"Score (Mean Items)") + 
#  theme_bw(base_size = 14) 
```

Replot original correlation with fitted model
```{r,fig.width=12,fig.height=7.5}
#ggplot(ms,aes(x = vocab, y = score, colour = age.binned, fill = age.binned,
#              label = age.binned)) + 
#  geom_jitter(size=1.5)+
#  geom_line(aes(y=predicted),size=1) + 
#  facet_wrap(~measure) + 
#  scale_x_continuous(limits = c(0,681), breaks = seq(0,680,100),name = "Vocabulary (WS)") + 
#  scale_y_continuous(limits = c(0, 1.05), breaks = seq(0,1,.2),"Score (Mean Items)") + 
#  theme_bw(base_size = 14) +
#  scale_color_brewer(palette="Set1") +
#  scale_fill_brewer(palette="Set1") 
```

Compute some descriptives on syntactic items
```{r,fig.width=7,fig.height=4}
# compute Kendall's tau -- cor.fk is a faster implementation than in stats::cor
#complex.cors <- cor.fk(as.matrix(bykid.syntax.vocab[,8:ncol(bykid.syntax.vocab)])) %>%
#  as.data.frame
#names(complex.cors) <- str_replace(names(complex.cors),"complx","")
#row.names(complex.cors) <- str_replace(row.names(complex.cors),"complx","")


# make a dendrogram of the complex item similarities
#complex.dendro <- as.dendrogram(hclust(dist(complex.cors)))

#plot(complex.dendro)
```

Make a confusion matrix
```{r,fig.width=8,fig.height=5}
# gather the columns for plotting as a confusion matrix
#complex.cors %<>%
#  mutate(prompt = factor(row.names(complex.cors))) %>%
#  gather(response,correlation,"01":"37")

#ggplot(complex.cors, aes(response, prompt)) + 
#  geom_tile(aes(fill = correlation)) +
#  ylim(rev(levels(complex.cors$prompt))) +
#  scale_fill_gradient(low = "white", high = "black",guide=FALSE) +
#  labs(x="Response", y = "Prompt") +
#  theme(legend.position = "none", axis.ticks = element_blank()) +
#  theme_bw(base_size = 16)
```

Compute vocab x age interaction terms for each styntactic item
```{r,fig.height=5,fig.width=8}
# write regression formulas for separately for each item
#formulas <- sapply(names(bykid.syntax.vocab)[8:ncol(bykid.syntax.vocab)],
#                   function(x) paste(x ,"~ I(vocab^2)*age + 0",collapse=""))

# compute interaction terms each item
#interaction.terms <- sapply(formulas, function(x)  
#  summary(glm(as.formula(x),data=bykid.syntax.vocab,
#              family="binomial"))$coefficients[3,3])
#names(interaction.terms) <- 1:37

#rename results to be human-readable
#interaction.terms <- as.data.frame(interaction.terms) %>%
#  mutate(item = 1:37) %>%
#  rename(zscore = interaction.terms) %>%
#  arrange(zscore) %>%
#  mutate(item = factor(item,levels=item))

# plot interaction terms by item
#ggplot(interaction.terms,
#       aes(x=item,y=zscore,fill=1))+
#  geom_bar(stat="identity")+
#  geom_hline(yintercept=mean(interaction.terms$zscore),
#             lty=2)+
#  theme_bw(base_size = 14) + 
#  scale_y_continuous(name="vocabulary size x age z-score",limits=c(0,15),
#                     breaks=seq(0,15,2.5))+
#  scale_x_discrete(name="complexity CDI item")+
#  scale_color_brewer(palette="Set1") + 
#  theme(legend.position="none")
```  

Leftover analyses
```{r}
#summary(lm(syntax ~ I(vocab^2) * age - 1, data=d))
#summary(lm(morpho ~ I(vocab^2) * age - 1, data=d))

#summary(lm(syntax ~ I(d$s.vocab^2) * d$age_bin - 1, data=d))
#summary(lm(morpho ~ I(d$s.vocab^2) * d$age_bin - 1, data=d))
```

% Grammatical Category Analysis
% Dan Yurovsky, Mika Braginsky, & Mike Frank (in no particular order)
% `r as.character(format(Sys.Date(), format="%B %d, %Y"))`

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(cache=TRUE, message=FALSE, warning=FALSE)
```

***

## Data Loading

Load required libraries
```{r libraries}
rm(list=ls())
library(ggplot2)
library(dplyr)
library(tidyr)
library(RMySQL)
library(stringr)
library(pcaPP)
library(directlabels)
library(proto)
library(Unicode)
library(RGtk2)
```

Load in wordbank data
```{r database}
## OPEN DATABASE CONNECTION ##
wordbank <- src_mysql(dbname="wordbank", host="54.149.39.46",
                      user="wordbank", password="wordbank")

## NOW LOAD TABLES ##
source.table <- tbl(wordbank, "common_source")
admin.table <- tbl(wordbank, "common_administration")
child.table <- tbl(wordbank, "common_child")
wordmapping.table <- tbl(wordbank, "common_wordmapping")
instruments.table <- tbl(wordbank, "common_instrumentsmap")
english.ws.table <- tbl(wordbank, "instruments_english_ws")
spanish.ws.table <- tbl(wordbank, "instruments_spanish_ws")
norwegian.ws.table <- tbl(wordbank, "instruments_norwegian_ws")
danish.ws.table <- tbl(wordbank, "instruments_danish_ws")
```

Get kid data and put together. 
```{r child_data}
# Get administration info
admins <- admin.table %>%
  select(data_id,child_id,age,source_id) %>%
  rename(id = data_id, child.id = child_id, source.id = source_id) 
admins <- as.data.frame(admins)

# Get demographic variables for each child
demos <- select(child.table,id,sex,mom_ed,birth_order) %>%
  rename(child.id = id) # Rename id fields
demos <- as.data.frame(demos)

# Join age and demographics together
child.data <- as.tbl(left_join(admins,demos))
```

Set up mappings and instruments.
```{r item_data}
mapping <- as.data.frame(wordmapping.table)
instruments <- as.data.frame(instruments.table) %>%
  rename(instrument_id = id)
items <- left_join(mapping, instruments)
```

Fucntion for getting all of the data in wordbank for a given language (kid x item).
```{r}
get.language.data <- function(lang.table, lang.items, lang, child.data) {
  
  instrument.items <- lang.items %>% 
    filter(language == lang, form == 'WS') %>%
    select(item, type, category, lexical_category, definition) %>%
    mutate(item = str_replace(item, "\\.", "_")) # Fix _/. inconsistencies
  
  instrument.data <- as.data.frame(lang.table) %>%
    rename(id = basetable_ptr_id) %>% # Rename the id
    gather(item, value, -id) %>% # Arrange in longform
    mutate(item = str_replace(item, "item_", "")) # Strip off item_ 
  
  d <- left_join(instrument.data, instrument.items)
  d <- left_join(d, child.data)
  }
```

Get (kid x item) data for all languages.
```{r}
d.english <- get.language.data(lang.table=english.ws.table, 
                               lang.items=items, 
                               lang="English",
                               child.data)

d.spanish <- get.language.data(lang.table=spanish.ws.table, 
                               lang.items=items, 
                               lang="Spanish",
                               child.data)

d.norwegian <- get.language.data(lang.table=norwegian.ws.table, 
                                 lang.items=items, 
                                 lang="Norwegian",
                                 child.data)

# Norwegian data is loaded in funny -- NAs in wordform are actually 0s
d.norwegian[d.norwegian$type %in% c("word_form","word")
            & is.na(d.norwegian$value),]$value = ""

d.danish <- get.language.data(lang.table=danish.ws.table, 
                              lang.items=items, 
                              lang="Danish",
                              child.data)

# Danish data is loaded in funny -- NAs in wordform are actually 0s
d.danish[d.danish$type %in% c("word_form","word")
         & is.na(d.danish$value),]$value = ""
```

Function for getting vocab size data.
```{r}
language.vocab.sizes <- function(lang.data) {
  d.vocab <- lang.data %>%
    filter(type == "word") %>%
    group_by(age,id) %>%
    summarise(vocab.sum = sum(value == "produces", na.rm=TRUE),
              vocab.mean = vocab.sum/length(value))
  
  return(d.vocab)
  }
```

***

## Syntax and Morphology Analyses

Function for getting (kid x {vocab size, syntax score, morphology score}) data.
```{r}
summarise.language.data <- function(lang.data,lang) {
  
  d.vocab <- language.vocab.sizes(lang.data)
  
  d.complexity <- lang.data %>%
    filter(type == "complexity") %>%
    group_by(id) %>%
    summarise(all.na = all(is.na(value)),
              complexity.sum = sum(value == "complex", 
                                   na.rm=TRUE) / length(value)) %>%
    mutate(complexity = ifelse(all.na,NA,complexity.sum)) %>%
    select(-all.na,-complexity.sum) # Deals with ifelse 
  # forcing values to logical
  
  d.wordform <- lang.data %>%
    filter(type == "word_form") %>%
    group_by(id) %>%
    summarise(all.na = all(is.na(value)),
              wordform.sum = sum(value == "produces", 
                                 na.rm=TRUE) / length(value)) %>%
    mutate(wordform = ifelse(all.na,NA,wordform.sum)) %>%
    select(-all.na,-wordform.sum) # Deals with ifelse 
  # forcing values to logical
  
  # Spanish doesn't have ending data, so its skipped, at least for now.
  #   d.ending <- d %>%
  #     filter(type %in% c("ending")) %>%
  #     group_by(id) %>%
  #     summarise(ending_sometimes = mean(value == "sometimes" | 
  #                                       value == "often", 
  #                                       na.rm=TRUE), 
  #               ending_often = mean(value == "often", 
  #                                   na.rm=TRUE))
  #  d.composite <- left_join(d.composite, d.ending)
  
  d.composite <- left_join(d.vocab, d.complexity)
  d.composite <- left_join(d.composite, d.wordform) %>%
      ungroup() %>%
      filter(age > 15 & age < 32) %>%
      mutate(age.group = cut(age, breaks = c(15, 19, 23, 27, 31)),
             age.bin = cut(age, quantile(age), include.lowest=T))

  d.composite$age.bin <- factor(d.composite$age.bin, labels=c(1,2,3,4))
  #   %>%
  #     filter(num.complexity.na == 0) %>%
  #     select(-num.complexity.na)
  #   
  d.composite$language <- lang
  
  return(d.composite)
  }
```

Get (kid x {vocab size, syntax score, morphology score}) data for all languages and aggregate them.
```{r}
summary.english <- summarise.language.data(d.english,"English")
summary.spanish <- summarise.language.data(d.spanish,"Spanish")
summary.norwegian <- summarise.language.data(d.norwegian,"Norwegian")
summary.danish <- summarise.language.data(d.danish,"Danish")
 
summary.data <- rbind_list(summary.english, summary.spanish,
                           summary.norwegian, summary.danish) %>%
  mutate(language = factor(language, levels=c("English", "Spanish", 
                                              "Norwegian", "Danish")))
# gather for plotting
ms <- summary.data %>% gather(measure, score, complexity:wordform) %>%
  mutate(measure = factor(measure, levels = c("wordform","complexity"),
                          labels = c("Word Form", "Complexity")))
#ms %>% 
#  group_by(language, age.bin) %>% 
#  summarise(n = n())

```

Using Age and Vocab to predict Morphology and Syntax Scores.
```{r, fig.width=12, fig.height=8}
#quartz(width=8,height=7.5)
#ggplot(ms, aes(x = vocab.mean, y = score, colour = age.group, fill = age.group,
#               label = age.group)) + 
ggplot(ms, aes(x = vocab.mean, y = score, colour = age.bin, fill = age.bin,
               label = age.bin)) + 
  #geom_point(alpha=.5, size=.8) + 
  geom_jitter(alpha=.6, ssize=.8) +
  geom_smooth(method="lm", formula = y ~ I(x^2) - 1) + 
  facet_grid(language~measure) + 
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,.1),
                     name = "Vocabulary Size") + 
  scale_y_continuous(limits = c(0, 1.05), breaks = seq(0,1,.2),
                     "Score (Mean Items)") + 
  theme_bw(base_size = 14) +
  scale_color_brewer(palette="Set1") +
  scale_fill_brewer(palette="Set1") 
```

Using Morphology scores to predict Syntax scores.
```{r, fig.width=8, fig.height=6}
#quartz(width=8,height=7.5)
ggplot(summary.data,aes(x = wordform, y = complexity, fill=age.group,colour=age.group,
                        label=age.group)) + 
  facet_wrap( ~ language) +
  geom_jitter(size=1)+
  geom_smooth(method="lm", formula = y ~ exp(x) - 1) + 
  scale_x_continuous(limits = c(0,1.05), breaks=seq(0,1,.2),
                     name = "Morphology Score") + 
  scale_y_continuous(limits = c(0,1.05), breaks=seq(0,1,.2),"Syntax Score") + 
  scale_color_brewer(palette="Set1") +
  scale_fill_brewer(palette="Set1") +
  theme_bw(base_size = 14)
```

Examine relationship between vocab size, age, and syntax/morphology scores.
```{r}
# fit regressions to data
english.lm.grp <- lm(score ~ I((vocab.mean*100)^2) * age.group * measure - age.group - measure - 1,
                     data=filter(ms,language=="English"))
spanish.lm.grp <- lm(score ~ I((vocab.mean*100)^2) * age.group * measure - age.group - measure - 1, 
                     data=filter(ms,language=="Spanish"))
norwegian.lm.grp <- lm(score ~ I((vocab.mean*100)^2) * age.group * measure - age.group - measure - 1, 
                       data=filter(ms,language=="Norwegian"))
danish.lm.grp <- lm(score ~ I((vocab.mean*100)^2) * age.group * measure - age.group - measure - 1, 
                    data=filter(ms,language=="Danish"))

#english.lm.bin <- lm(score ~ I((vocab.mean*100)^2) * age.bin * measure - age.bin - measure - 1,
#                     data=filter(ms,language=="English"))
#spanish.lm.bin <- lm(score ~ I((vocab.mean*100)^2) * age.bin * measure - age.bin - measure - 1, 
#                     data=filter(ms,language=="Spanish"))
#norwegian.lm.bin <- lm(score ~ I((vocab.mean*100)^2) * age.bin * measure - age.bin - measure - 1, 
#                       data=filter(ms,language=="Norwegian"))
#danish.lm.bin <- lm(score ~ I((vocab.mean*100)^2) * age.bin * measure - age.bin - measure - 1, 
#                    data=filter(ms,language=="Danish"))

english.lm.noage <- lm(score ~ I((vocab.mean*100)^2) * measure - measure - 1,
                       data=filter(ms,language=="English"))
spanish.lm.noage <- lm(score ~ I((vocab.mean*100)^2) * measure - measure - 1, 
                       data=filter(ms,language=="Spanish"))
norwegian.lm.noage <- lm(score ~ I((vocab.mean*100)^2) * measure - measure - 1, 
                         data=filter(ms,language=="Norwegian"))
danish.lm.noage <- lm(score ~ I((vocab.mean*100)^2) * measure - measure - 1, 
                      data=filter(ms,language=="Danish"))

predicted.data <- as.data.frame(ms)

predicted.data$predicted.grp <- NA
predicted.data$predicted.bin <- NA

predicted.data[predicted.data$language=="English",]$predicted.grp <- 
  predict.lm(english.lm.grp, predicted.data[predicted.data$language=="English",])
predicted.data[predicted.data$language=="Spanish",]$predicted.grp <- 
  predict.lm(spanish.lm.grp, predicted.data[predicted.data$language=="Spanish",])
predicted.data[predicted.data$language=="Norwegian",]$predicted.grp <- 
  predict.lm(norwegian.lm.grp, predicted.data[predicted.data$language=="Norwegian",])
predicted.data[predicted.data$language=="Danish",]$predicted.grp <- 
  predict.lm(danish.lm.grp, predicted.data[predicted.data$language=="Danish",])

#predicted.data[predicted.data$language=="English",]$predicted.bin <- 
#  predict.lm(english.lm.bin, predicted.data[predicted.data$language=="English",])
#predicted.data[predicted.data$language=="Spanish",]$predicted.bin <- 
#  predict.lm(spanish.lm.bin, predicted.data[predicted.data$language=="Spanish",])
#predicted.data[predicted.data$language=="Norwegian",]$predicted.bin <- 
#  predict.lm(norwegian.lm.bin, predicted.data[predicted.data$language=="Norwegian",])
#predicted.data[predicted.data$language=="Danish",]$predicted.bin <- 
#  predict.lm(danish.lm.bin, predicted.data[predicted.data$language=="Danish",])
```

Replot original correlation with fitted model.
```{r,fig.width=12,fig.height=8}
#quartz(width=6,height=6)
ggplot(predicted.data, aes(x = vocab.mean, y = score, 
                           colour = age.group, fill = age.group,
                           label = age.group)) + 
  geom_jitter(alpha=.3, size=.75) +
  geom_line(aes(y=predicted.grp),size=0.65) + 
#  facet_grid(measure~language) + 
  facet_grid(language~measure) + 
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,.1),
                     name = "Vocabulary Size") + 
  scale_y_continuous(limits = c(0, 1.05), breaks = seq(0,1,.2),
                     "Score (Mean Items)") + 
  theme_bw(base_size = 11) +
  theme(legend.position = c(0.06,0.912),
        legend.text = element_text(size=6),
        legend.title = element_text(size=6),
        legend.key.height = unit(0.8, "char"),
        legend.key.width = unit(0.4, "cm"),
        legend.key = element_blank(),
        legend.background = element_rect(fill="transparent")) +
  scale_color_brewer(palette="Set1",
                     name="Age Group\n (months)") +
#                     labels=c("16-19","20-23","24-27","28-31")) +
  scale_fill_brewer(palette="Set1",
                    guide=FALSE)
ggsave(file=("~/Documents/projects/wordbank_nsf/figures/grammar.png"), width=6, height=6, dpi=500)
```

Same plot but with equal number of kids age bins.
```{r,fig.width=12,fig.height=8}
#quartz(width=6,height=6)
ggplot(predicted.data, aes(x = vocab.mean, y = score, 
                           colour = age.bin, fill = age.bin,
                           label = age.bin)) + 

  geom_jitter(alpha=.6, size=.8, pch="o") +
  geom_line(aes(y=predicted.bin),size=0.8) + 
#  facet_grid(measure~language) + 
  facet_grid(language~measure) + 
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,.2),
                     name = "Vocabulary Size") + 
  scale_y_continuous(limits = c(0, 1.05), breaks = seq(0,1,.2),
                     "Score (Mean Items)") + 
  theme_bw(base_size = 11) +
  theme(legend.position = "bottom") +
  scale_color_brewer(palette="Set1",
                     name="Age Group (months)") +
#                     labels=c("16-19","20-23","24-27","28-31")) +
  scale_fill_brewer(palette="Set1",
                    guide=FALSE)
#ggsave(file=("grammar.pdf"), width=6, height=6)
```

```{r}
#plot.measure <- function(meas) {
#plot <- ggplot(filter(predicted.data, measure==meas),
#               aes(x = vocab.mean, y = score, 
#               colour = age.group, fill = age.group,
#               label = age.group)) +
#  geom_jitter(alpha=.6,size=.8, pch="o") +
#  geom_line(aes(y=predicted.grp),size=0.9) + 
#  facet_grid(language~.) + 
#  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,.1),
#                     name = "Vocabulary Size") + 
#  scale_y_continuous(limits = c(0, 1.05), breaks = seq(0,1,.2),
#                     paste(meas, "Score (Mean Items)")) + 
#  theme_bw(base_size = 11) +
#  scale_color_brewer(palette="Set1",
#                     name="Age Group\n (months)",
#                     labels=c("16-19","20-23","24-27","28-31")) +
#  scale_fill_brewer(palette="Set1",
#                    guide=FALSE) +
#  theme(legend.position = "bottom",
#        legend.background = element_rect(colour = "grey"))
#return(plot)
#}
```

```{r}
#quartz(width=4,height=7)
#plot.measure("Complexity") %>%
#ggsave(file=("complexity.pdf"), width=4, height=7)

#quartz(width=4,height=7)
#plot.measure("Word Form") %>%
#ggsave(file=("wordform.png"), width=4, height=7)
```

Compute (vocab x age) interaction coefficients for each measure and language.
```{r}
mod.coef.fun <- function(score, vocab.mean, age) {
#  return(coef(lm(score ~ I((vocab.mean*100)^2) * age + I(vocab.mean*100) * age - age + 0))[2])
#  return(coef(lm(score ~ I((vocab.mean*100)^2) * age + I(vocab.mean*100) * age + 0))[])
  return(coef(lm(score ~ I((vocab.mean * 100)^2) * age + 0))["I((vocab.mean * 100)^2):age"])
  }

mod.se.fun <- function(score, vocab.mean, age) {
#  return(summary(lm(score ~ I((vocab.mean*100)^2) * age + I(vocab.mean*100) * age - age + 0))$coefficients[2,2])
  return(summary(lm(score ~ I((vocab.mean*100)^2) * age + 0))$coefficients["I((vocab.mean * 100)^2):age",
                                                                           "Std. Error"])
  }

grammar.coefs <- ms %>% 
  group_by(language, measure) %>%
  summarise(coef = mod.coef.fun(score,vocab.mean,age),
            se = mod.se.fun(score,vocab.mean,age))
```

Plot coefficients for each language.
```{r}
quartz(width=6, height=4)
ggplot(grammar.coefs, 
       aes(x=language, y=coef, fill=measure)) + 
  geom_bar(position="dodge", stat="identity") + 
  geom_linerange(aes(ymin=coef-se, ymax=coef+se), 
                 position = position_dodge(width=.9)) +
  ylab("Age interaction coefficient") + 
  xlab("Language") +
  theme_bw(base_size = 14) +
  scale_fill_brewer(palette = "Set1",
                    name="") +
  theme(legend.position = c(0.12,0.95),
        legend.text = element_text(size=10),
        legend.key.height = unit(0.9, "char"),
        legend.key.width = unit(0.4, "cm"),
        legend.key = element_blank(),
        legend.background = element_rect(fill="transparent"))
ggsave(file=("~/Documents/projects/cdi-grammar/cogsci_paper/plots/coefs_wordform_complexity.png"), width=6, height=4)
```

Get (kid x item x {vocab size, value}) data for wordform and complexity items.
```{r}
grammar.by.item <- function(lang.data, lang) {
  
  d.vocab <- language.vocab.sizes(lang.data)
  
  d.complexity <- lang.data %>%
    filter(type == "complexity") %>%
    mutate(value = value == "complex") %>%
    select(-lexical_category, -category)
  
  d.wordform <- lang.data %>%
    filter(type == "word_form") %>%
    mutate(value = value == "produces") %>%
    select(-lexical_category, -category)
  
  d.data <- rbind(d.complexity, d.wordform)
  d.data <- left_join(d.vocab, d.data) %>%
    filter(age > 15, age < 33)
  
  return(d.data)
  }

english.grammar.by.item <- grammar.by.item(d.english,"English")
spanish.grammar.by.item <- grammar.by.item(d.spanish,"Spanish")
norwegian.grammar.by.item <- grammar.by.item(d.norwegian,"Norwegian")
danish.grammar.by.item <- grammar.by.item(d.danish,"Danish")
```

Compute (vocab x age) interaction terms for each wordform and complexity item.
```{r,fig.height=5,fig.width=8}
#compute interaction terms each item
i.terms.function <- function(data,x) {
  return(summary(glm(value ~ I((vocab.mean*100)^2)*age+0, 
                     data=filter(data,definition==x),
                     family="binomial"))$coefficients[3,3])
  }

# complexity.diff <- function(item) {
#   
#   if(length(grep("/", item)) == 0) {return(item)}
#   else{
#     phrases <- str_split(item," / ")[[1]]
#     first.phrase <- str_split(phrases[1], " ")[[1]]
#     second.phrase <- str_split(phrases[2], " ")[[1]]
#   
#     first.diff <- setdiff(first.phrase,second.phrase)
#     second.diff <- setdiff(second.phrase,first.phrase)
#   
#     if(length(first.diff)==0) return(paste(second.diff,collapse=" ")) 
#     else if(length(second.diff)==0) return(paste(first.diff,collapse=" "))
#     else{first.phrase = paste(first.diff, collapse =" ")
#          second.phrase = paste(second.diff,collapse = " ")
#          return(paste(first.phrase, second.phrase ,sep=" / "))}
#     }
#   }

 complexity.diff <- function(item) {
   return(item)
   }

lang.interaction.terms<- function(grammar.by.item) {
  
  complexity.terms <- sapply(unique(filter(grammar.by.item,
                                           type=="complexity")$definition), 
                             function(item) i.terms.function(grammar.by.item,
                                                             item))
  
  complexity.terms <- data.frame(type = "complexity",
                                 definition=names(complexity.terms),
#                                 item=1:length(complexity.terms),
                                 term = complexity.terms,
                                 row.names=NULL) %>%
    mutate(definition = sapply(definition,complexity.diff),
           item = definition) %>%
#           item = paste(item,definition,sep=". ")) %>%
    select(-definition)
  
  wordform.terms <- sapply(unique(filter(grammar.by.item,
                                         type=="word_form")$definition), 
                           function(item) i.terms.function(grammar.by.item,
                                                           item))
  
  wordform.terms <- data.frame(type = "wordform",
                               item=names(wordform.terms),
                               term = wordform.terms,
                               row.names=NULL)
  
  #rename results to be human-readable
  interaction.terms <- rbind(complexity.terms, wordform.terms) %>%
    arrange(term) %>%
    mutate(item = factor(item,levels=item))
  
  return(interaction.terms)
  }

#spanish.grammar.by.item$definition <- spanish.grammar.by.item$item
#norwegian.grammar.by.item$definition <- norwegian.grammar.by.item$item
#danish.grammar.by.item$definition <- danish.grammar.by.item$item

english.interaction.terms <- lang.interaction.terms(english.grammar.by.item)
spanish.interaction.terms <-lang.interaction.terms(spanish.grammar.by.item)
norwegian.interaction.terms <- lang.interaction.terms(norwegian.grammar.by.item)
danish.interaction.terms <-  lang.interaction.terms(danish.grammar.by.item)
```

Plot interaction terms by item for each language.
```{r}
interaction.plot <- function(lang.interaction.terms, lang) {
  plt <- ggplot(lang.interaction.terms,
                aes(x=item,y=term,fill=type,label=item)) +
    geom_bar(stat="identity", position="identity", alpha=.5) +
    geom_text(y=0.15, angle=90, hjust=0, size=3.3, parse=F) +
    theme_bw(base_size = 12) +
    scale_y_continuous(name="Age x Vocabulary Interaction Z-score") +
    #                     limits=c(-10,20),
    #                     breaks=seq(-10,20,2.5)) +
    scale_x_discrete(name="CDI Item",breaks=NULL) +
    scale_fill_brewer(palette="Set1") +
    scale_colour_brewer(palette="Set1") +
    theme(legend.position="none") +
    ggtitle(lang)
  return(plt)
  }
```

```{r,fig.width=10,fig.height=5}
#quartz(width=10, height=5)
#cairo_pdf("~/Documents/english.pdf", family="DejaVu Sans", width=10, height=5)
interaction.plot(english.interaction.terms, "English")
ggsave(file=("~/Documents/projects/cdi-grammar/cogsci_paper/plots/english_interactions.png"), width=10, height=5)
```

```{r,fig.width=10,fig.height=5}
quartz(width=10, height=5)
#cairo_pdf("~/Documents/spanish.pdf", family="DejaVu Sans", width=10, height=5)
interaction.plot(spanish.interaction.terms, "Spanish") #%>%
#dev.off()
ggsave(file=("~/Documents/projects/cdi-grammar/cogsci_paper/plots/spanish_interactions.png"), width=10, height=5)
```

```{r,fig.width=10,fig.height=5}
interaction.plot(norwegian.interaction.terms, "Norwegian") #%>%
ggsave(file=("~/Documents/projects/cdi-grammar/cogsci_paper/plots/norwegian_interactions.png"), width=10, height=5)
```

```{r,fig.width=10,fig.height=5}
interaction.plot(danish.interaction.terms, "Danish") #$>$
ggsave(file=("~/Documents/projects/cdi-grammar/cogsci_paper/plots/danish_interactions.png"), width=10, height=5)
```  


***

## Vocabulary Composition Analysis

Function for computing vocabulary composition for each speaker of a language.
```{r}
vocab.composition <- function(lang.data,lang) {  
  
  d.vocab <- language.vocab.sizes(lang.data)
  
  d.cat <- lang.data %>%
    filter(type == "word") %>%
    group_by(id,lexical_category) %>%
    summarise(cat = sum(value == "produces", na.rm=TRUE))
  
  d.vocab.comp <- left_join(d.vocab, d.cat) %>%
    mutate(prop = cat / vocab.sum)
  d.vocab.comp$language = lang
  
  return(d.vocab.comp)
  }
```

Function for computing CDI form composition for all languages.
```{r}
lang.vocab.composition <- function(lang.items) {  
  
  lang.words <- lang.items %>%
    filter(form == "WS",type=="word")
  
  lang.num.total <- lang.words %>%
    group_by(language) %>%
    summarise(n = n())
  
  lang.vocab.comp <-  lang.words %>%
    group_by(language,lexical_category) %>%
    summarise(num.per.cat = n())
  
  lang.vocab.comp <- left_join(lang.vocab.comp, lang.num.total) %>%
    mutate(prop.per.cat = num.per.cat/n)
  
  return(lang.vocab.comp)
  
  }
```

Get vocabulary composition data for all languages.
```{r}
# get form compositions
lang.vocab.comp <- lang.vocab.composition(items) %>%
  ungroup() %>%
  mutate(language = factor(language,
                           levels = c("English", "Spanish", 
                                      "Norwegian", "Danish")),
         lexical_category = factor(lexical_category, 
                                   levels=c("nouns","predicates",
                                            "function_words","other"),
                                   labels=c("Nouns", "Predicates",
                                            "Function Words","Other"))) %>%
  filter(lexical_category != "Other")
  

# get data for kids in each language
vocab.comp.english <- vocab.composition(d.english,"English")
vocab.comp.spanish <- vocab.composition(d.spanish,"Spanish")
vocab.comp.norwegian <- vocab.composition(d.norwegian,"Norwegian")
vocab.comp.danish <- vocab.composition(d.danish,"Danish")

# aggregate data for all languages together
summary.vocab.comp <- rbind_list(vocab.comp.english,vocab.comp.spanish,
                                 vocab.comp.norwegian,vocab.comp.danish) %>%
#  filter(age > 15 & age < 33) %>%
  mutate(#age.group = cut(age, breaks = c(15, 20, 24, 28, 32)),
         language = factor(language,
                           levels = c("English", "Spanish", 
                                      "Norwegian", "Danish")),
         lexical_category = factor(lexical_category, 
                                   levels = c("nouns", "predicates", 
                                              "function_words", "other"),
                                   labels = c("Nouns", "Predicates", 
                                              "Function Words", "Other")))
summary.vocab.comp <- left_join(ms, summary.vocab.comp)
```

Plot vocabulary composition by language.
```{r, fig.width=10, fig.height=8}
ggplot(filter(summary.vocab.comp,lexical_category != "Other"),
       aes(x=vocab.mean, y=prop, colour=lexical_category, 
           shape = lexical_category, fill = lexical_category,
           label=lexical_category)) +
  geom_point(size = 1, alpha = 0.25) +
  facet_wrap(~ language) +
  geom_hline(data=lang.vocab.comp,aes(yintercept=prop.per.cat),
             linetype="dashed", color="grey") + #baselines for each language
  geom_smooth(aes(group=lexical_category), method='loess', span=0.5) +
  scale_y_continuous(name = "Proportion of total vocabulary") +
  scale_x_continuous(name = "Vocabulary Size") +
  geom_dl(aes(label=lexical_category), method=list("smart.grid")) +
  theme_bw(base_size=14) + 
  scale_color_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1")+
  theme(axis.text.x = element_text(angle=-40, hjust = 0),
        axis.title.y = element_text(vjust=0.35),
        axis.title.x = element_text(vjust=-0.5),
        legend.position="none")
```

Plot vocabulary composition by language and age group.
```{r, fig.width=10, fig.height=8}
ggplot(filter(summary.vocab.comp,lexical_category != "Other"),
       aes(x=vocab.mean, y=prop, colour=lexical_category, 
           shape = lexical_category, fill = lexical_category,
           label = lexical_category)) +
  geom_jitter(size = 1, alpha = 0.5) +
  facet_grid(language ~ age.group) +
  geom_hline(data=lang.vocab.comp,aes(yintercept=prop.per.cat),
             linetype="dashed", color="grey") + #baselines for each language
  geom_smooth(aes(group=lexical_category), method='loess', span=0.5) +
  scale_y_continuous(name = "Proportion of total vocabulary") +
  scale_x_continuous(name = "Vocabulary Size") +
  geom_dl(aes(label=lexical_category), method=list("smart.grid")) +
  theme_bw(base_size=14) + 
  scale_color_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1")+
  theme(axis.text.x = element_text(angle=-40, hjust = 0),
        axis.title.y = element_text(vjust=0.35),
        axis.title.x = element_text(vjust=-0.5),
        legend.position="none")
```

Plot vocabulary composition by language, split by age group.
```{r, fig.width=10, fig.height=8}
#quartz(width=7, height=6)
ggplot(filter(summary.vocab.comp, lexical_category != "Other"),
       aes(x=vocab.mean, y=prop, colour=age.group, linetype = lexical_category)) +
#  geom_jitter(size = 1, alpha = 0.5) +
  facet_wrap(~ language) +
  geom_hline(data=lang.vocab.comp, 
             aes(yintercept=prop.per.cat),
             linetype="dashed", color="grey") + #baselines for each language
  geom_smooth(method='loess', span=.5) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0,1,.2),
                     name = "Vocabulary Size") + 
  scale_y_continuous(limits = c(0, .6), breaks = seq(0,1,.2),
                     "Proportion of total vocabulary") + 
  theme_bw(base_size=14) + 
  scale_color_brewer(palette = "Set1", name = "Age Group (months)") +
  scale_fill_brewer(palette = "Set1") +
  scale_linetype(name = "Lexical Category") +
  theme(#axis.text.x = element_text(angle=-40, hjust = 0),
#        axis.title.y = element_text(vjust=0.35),
#        axis.title.x = element_text(vjust=-0.5),
        legend.position="bottom")
#ggsave(file=("age_composition.pdf"), width=7, height=6)
```

Plot vocabulary composition by language and lexical category.
```{r, fig.width=10, fig.height=8}
#quartz(width=8, height=6)
ggplot(filter(summary.vocab.comp, lexical_category != "Other"),
       aes(x=vocab.mean, y=prop, colour = age.group, fill = age.group)) +
#  geom_jitter(size = 1, alpha = 0.5) +
  facet_grid(language ~ lexical_category) +
  geom_hline(data=lang.vocab.comp, 
             aes(yintercept=prop.per.cat),
             linetype="dashed", color="grey") + #baselines for each language
  geom_smooth(aes(group=age.group), method='loess', span=0.5) +
  scale_y_continuous(name = "Proportion of total vocabulary") +
  scale_x_continuous(name = "Vocabulary Size") +
  theme_bw(base_size=14) + 
  scale_color_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1")+
  theme(axis.text.x = element_text(angle=-40, hjust = 0),
        axis.title.y = element_text(vjust=0.35),
        axis.title.x = element_text(vjust=-0.5),
        legend.position="none")
#ggsave(file=("age_composition.pdf"), width=8, height=6)
```

Re-compute vocabulary composition data as a proportion of items on the CDI rather than a proportion of vocabulary size.
```{r}
prop.comp <- left_join(filter(summary.vocab.comp, lexical_category != "Other"),
                        lang.vocab.comp) %>%
  mutate(cdi.prop = cat / num.per.cat) %>%
  select(-prop, -prop.per.cat, -n, -num.per.cat)
```

Use Age and Lexical Category Score to predict Morphology and Syntax Scores, for each lexical category.
```{r}
plot.vocab.comp.prediction <- function(category) {
  p <- ggplot(filter(prop.comp, lexical_category==category),
              aes(x = cdi.prop, y = score, colour = age.group, fill = age.group,
                  label = age.group)) + 
        #geom_point(alpha=.5, size=.8) + 
    geom_jitter(alpha=.5,size=.8) +
    geom_smooth(method="lm", formula = y ~ I(x^2) - 1) + 
    facet_grid(language ~ measure) + 
    scale_x_continuous(limits = c(0,1), breaks = seq(0,1,.1),
                       name = "Category Size") + 
    scale_y_continuous(limits = c(0, 1.05), breaks = seq(0,1,.2),
                       "Score (Mean Items)") + 
    theme_bw(base_size = 14) +
    ggtitle(category) +
    scale_color_brewer(palette="Set1") +
    scale_fill_brewer(palette="Set1") 
  
  return(p)
}
```

```{r, fig.width=10, fig.height=8}
plot.vocab.comp.prediction("Nouns")
```

```{r, fig.width=10, fig.height=8}
plot.vocab.comp.prediction("Predicates")
```

```{r, fig.width=10, fig.height=8}
plot.vocab.comp.prediction("Function Words")
```

Fit models to vocab composition data.
```{r}
comp.lm <- function(lang) {
  
  prop.comp.lang <- filter(prop.comp, language == lang, lexical_category != "Other")
  comp.age.lm <- lm(cdi.prop ~ lexical_category : I((vocab.mean*100)^2):age.group +
                           lexical_category : I((vocab.mean*100)):age.group + 0,
                         data=prop.comp.lang)
  comp.noage.lm <- lm(cdi.prop ~ lexical_category : I((vocab.mean*100)^2) + 
                           lexical_category : I((vocab.mean*100)) + 0,
                         data=prop.comp.lang)
  prop.comp.lang$age.predict <- predict.lm(comp.age.lm)
  prop.comp.lang$noage.predict <- predict.lm(comp.noage.lm)
  prop.comp.lang$language <- lang
  return(prop.comp.lang)
  }

comp.english <- comp.lm("English")
comp.spanish <- comp.lm("Spanish")
comp.norweigian <- comp.lm("Norwegian")
comp.danish <- comp.lm("Danish")

comp.all <- rbind(comp.english, comp.spanish, comp.norweigian, comp.danish) %>%
  mutate(language = factor(language,
                           levels = c("English", "Spanish", "Norwegian", "Danish")))
```

Plot predictions of model with age.
```{r, fig.width=10, fig.height=6}
#quartz(width=10, height=6)
ggplot(comp.all,
       aes(x=vocab.mean, y=cdi.prop, colour=age.group, linetype=lexical_category)) +
#       aes(x=vocab.mean, y=cdi.prop, colour=lexical_category, 
#           shape=lexical_category, fill=lexical_category,
#           label=lexical_category)) +
#  geom_jitter(size=0.7, alpha=0.2, pch="o") +
  geom_line(aes(y = age.predict)) +
  facet_wrap(~language) +
#  geom_hline(data=lang.vocab.comp,aes(yintercept=prop.per.cat),
#             linetype="dashed", color="grey") + #baselines for each language
  #geom_smooth(aes(group=lexical_category), method='loess', span=0.5) +
  scale_y_continuous(name = "Proportion of CDI Category") +
  scale_x_continuous(name = "Vocabulary Size") +
#  geom_dl(aes(label=lexical_category), method=list("smart.grid")) +
  theme_bw(base_size=14) + 
  scale_color_brewer(palette = "Set1", name = "Age Group (months)") +
  scale_linetype(name = "Lexical Category") +
  theme(axis.text.x = element_text(angle=-40, hjust = 0),
        axis.title.y = element_text(vjust=0.35),
        axis.title.x = element_text(vjust=-0.5),
        legend.position="right")
#ggsave(file=("composition_model_age_points.png"), width=10, height=6)
```

Plot predictions of model without age.
```{r, fig.width=10, fig.height=8}
#quartz(width=10, height=6)
ggplot(comp.all,
       aes(x=vocab.mean, y=cdi.prop, colour=age.group, linetype=lexical_category)) +
#       aes(x=vocab.mean, y=cdi.prop, colour=lexical_category, 
#           shape=lexical_category, fill=lexical_category,
#           label=lexical_category)) +
#  geom_jitter(size=0.7, alpha=0.2, pch="o") +
  geom_line(aes(y = noage.predict)) +
  facet_wrap(~language) +
#  geom_hline(data=lang.vocab.comp,aes(yintercept=prop.per.cat),
#             linetype="dashed", color="grey") + #baselines for each language
  #geom_smooth(aes(group=lexical_category), method='loess', span=0.5) +
  scale_y_continuous(name = "Proportion of CDI Category") +
  scale_x_continuous(name = "Vocabulary Size") +
#  geom_dl(aes(label=lexical_category), method=list("smart.grid")) +
  theme_bw(base_size=14) + 
  scale_color_brewer(palette = "Set1", name = "Age Group (months)") +
  scale_linetype(name = "Lexical Category") +
  theme(axis.text.x = element_text(angle=-40, hjust = 0),
        axis.title.y = element_text(vjust=0.35),
        axis.title.x = element_text(vjust=-0.5),
        legend.position="right")
#ggsave(file=("composition_model_age_points.png"), width=10, height=6)
```

Plot new vocabulary composition by language.
```{r, fig.width=10, fig.height=8}
quartz(width=10, height=2.9)
ggplot(filter(prop.comp, lexical_category != "Other"),
       aes(x=vocab.mean, y=cdi.prop, colour=lexical_category, label=lexical_category)) +
  geom_jitter(alpha=0.17, size=0.75) +
  facet_wrap(~ language, nrow = 1, ncol = 4,) +
  geom_smooth(aes(group=lexical_category), method='loess', span=0.5) +
  scale_y_continuous(limits = c(0, 1.05), breaks = seq(0,1,.2),
                     name = "Proportion of CDI Category") +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,.2),
                     name = "Vocabulary Size") +
  theme_bw(base_size=12) + 
  scale_color_brewer(palette = "Set1", name = "Lexical Category") +
  theme(legend.position = c(0.055,0.82),
        legend.text = element_text(size=7),
        legend.title = element_text(size=8),
        legend.key.height = unit(0.9, "char"),
        legend.key.width = unit(0.3, "cm"),
        legend.key = element_blank(),
        legend.background = element_rect(fill="transparent"))
#ggsave(file=("composition.pdf"), width=8, height=6)
ggsave(file=("~/Documents/projects/cdi-grammar/cogsci_paper/plots/composition.png"), width=10, height=2.9, dpi=300)
```

Compute (vocab x age) interaction coefficients for each lexical category and language.
```{r}
quad.mod.coef.fun <- function(cdi.prop, vocab.mean, age) {
  return(coef(lm(cdi.prop ~ I((vocab.mean*100)^2) * age + I(vocab.mean*100) + 0))["I((vocab.mean * 100))^2:age"])
  }

quad.mod.se.fun <- function(cdi.prop, vocab.mean, age) {
  return(summary(lm(cdi.prop ~ I((vocab.mean*100)^2) * age + I(vocab.mean*100) + 0))$coefficients["I((vocab.mean * 100))^2:age", "Std. Error"])
  }

compute.model <- function(cdi.prop, vocab.mean, age) {
  return(lm(cdi.prop ~ I((vocab.mean*100)^2) * age + I(vocab.mean*100) + 0))
}

#comp.coefs <- prop.comp %>% 
#  group_by(language, lexical_category) %>%
#  do(model = lm(.$cdi.prop ~ I((.$vocab.mean*100)^2) * .$age + 
#                  I(.$vocab.mean*100) + 0)[[1]]) %>%
#  mutate(coef = coef(model)["I((.$vocab.mean * 100)^2):.$age"],
#         s = summary(model)$coefficients),
#         se = summary(model)$coefficients["I((.$vocab.mean * 100)^2):.$age", "Std. Error"])

comp.coefs <- prop.comp %>%
  group_by(language, lexical_category) %>%
  summarise(#coef = coef(model)["I((vocab.mean * 100)^2):age"]),
            #se = summary(model)$coefficients["I((vocab.mean * 100)^2):age", "Std. Error"])
            coef = mod.coef.fun(cdi.prop, vocab.mean, age),
            se = mod.se.fun(cdi.prop, vocab.mean, age))

#linear(vocab)
#linear(vocab)*age
#linear(vocab)*age + quadratic(vocab)
#linear(vocab)*age + quadratic(vocab)*age
#linear(vocab) + quadratic(vocab)*age

model1 <- lm(cdi.prop ~ I((vocab.mean*100)^2) * age + I(vocab.mean*100) * age + 0,
        data=filter(prop.comp, language=='English', lexical_category=='Nouns'))

model2 <- lm(cdi.prop ~ I((vocab.mean*100)^2) + I(vocab.mean*100) * age + 0,
        data=filter(prop.comp, language=='English', lexical_category=='Nouns'))

model3 <- lm(cdi.prop ~ I((vocab.mean*100)^2)*age + I(vocab.mean*100) + 0,
        data=filter(prop.comp, language=='English', lexical_category=='Nouns'))

model4 <- lm(cdi.prop ~ I((vocab.mean*100)^2) + I(vocab.mean*100) + 0,
        data=filter(prop.comp, language=='English', lexical_category=='Nouns'))

model5 <- lm(cdi.prop ~ I((vocab.mean*100)^2)*age + 0,
        data=filter(prop.comp, language=='English', lexical_category=='Nouns'))

model6 <- lm(cdi.prop ~ I((vocab.mean*100)^2):age + 0,
        data=filter(prop.comp, language=='English', lexical_category=='Nouns'))
```

Plot coefficients for each language.
```{r}
quartz(width=6, height=4)
ggplot(comp.coefs, 
       aes(x=language, y=coef, fill=lexical_category)) + 
  geom_bar(position="dodge", stat="identity") + 
  geom_linerange(aes(ymin=coef-se, ymax=coef+se), 
                 position = position_dodge(width=.9)) +
  ylab("Age interaction coefficient") + 
  xlab("Language") +
  theme(legend.position = "bottom") +
  theme_bw(base_size = 14) +
  scale_fill_brewer(palette = "Set1",
                    name="")
#ggsave(file=("coeffs.pdf"), width=6, height=4)
```

```{r}
get.pos <- function(lex_cat, cat) {
  if(lex_cat == "nouns"){
    return("nouns")
    } else if (cat == "action_words"){
      return("verbs")
      } else {
        return("other")
        }
  }

noun.verb.comp <- function(lang.data,lang) {  
    
  lang.data <- lang.data %>%
    rowwise() %>%
    mutate(pos = get.pos(lexical_category, category))
  
  d.vocab <- language.vocab.sizes(lang.data)
  
  d.pos <- lang.data %>%
    filter(type == "word") %>%
    group_by(id, pos) %>%
    summarise(pos.size = sum(value == "produces", na.rm=TRUE))
  
  d.vocab.comp <- left_join(d.vocab, d.pos)
  d.vocab.comp$language = lang
  
  return(d.vocab.comp)
  }

# get data for kids in each language
noun.verb.english <- noun.verb.comp(d.english,"English")
noun.verb.spanish <- noun.verb.comp(d.spanish,"Spanish")
noun.verb.norwegian <- noun.verb.comp(d.norwegian,"Norwegian")
noun.verb.danish <- noun.verb.comp(d.danish,"Danish")

# aggregate data for all languages together
summary.noun.verb <- rbind_list(noun.verb.english, noun.verb.spanish,
                                 noun.verb.norwegian, noun.verb.danish) %>%
  mutate(language = factor(language,
                           levels = c("English", "Spanish", 
                                      "Norwegian", "Danish")),
         pos = factor(pos, 
                      levels = c("nouns", "verbs", "other"),
                      labels = c("Nouns", "Verbs", "Other")))
summary.noun.verb <- left_join(ms, summary.noun.verb) %>%
  filter(pos != "Other")

get.lang.noun.verb <- function(lang.items) {  
  
  lang.words <- lang.items %>%
    filter(form == "WS", type=="word") %>%
    rowwise() %>%
    mutate(pos = get.pos(lexical_category, category))
  
  lang.noun.verb <- lang.words %>%
    group_by(language, pos) %>%
    summarise(num.per.pos = n())
    
  return(lang.noun.verb)
  
  }

lang.noun.verb <- get.lang.noun.verb(items)
lang.noun.verb %<>%
  ungroup() %>%
  mutate(language = factor(language,
                           levels = c("English", "Spanish", 
                                      "Norwegian", "Danish")),
         pos = factor(pos, 
                      levels=c("nouns", "verbs", "other"),
                      labels=c("Nouns", "Verbs", "Other"))) %>%
  filter(pos != "Other")

prop.noun.verb <- left_join(summary.noun.verb, lang.noun.verb) %>%
  mutate(pos.prop = pos.size / num.per.pos)
```


```{r, fig.width=10, fig.height=8}
quartz(width=8, height=6)
ggplot(prop.noun.verb, aes(x=vocab.mean, y=pos.prop, colour=pos, label=pos)) +
  geom_jitter(alpha=0.17, size=0.75) +
  facet_wrap(~ language) +
  geom_smooth(aes(group=pos), method='loess', span=0.5) +
  scale_y_continuous(limits = c(0, 1.05), breaks = seq(0,1,.2),
                     name = "Proportion of Part of Speech") +
  scale_x_continuous(limits = c(0,1), breaks = seq(0,1,.1),
                     name = "Vocabulary Size") +
  theme_bw(base_size=11) + 
  scale_color_brewer(palette = "Set1", name = "Lexical Category") +
  theme(legend.position = c(0.09,0.92),
        legend.text = element_text(size=9),
        legend.title = element_text(size=9),
        legend.key.height = unit(0.9, "char"),
        legend.key.width = unit(0.4, "cm"),
        legend.key = element_blank(),
        legend.background = element_rect(fill="transparent"))
#ggsave(file=("~/Documents/projects/wordbank_nsf/figures/composition.png"), width=8, height=6, dpi=500)
```

```{r}
linear.mod.coef.fun <- function(pos.prop, vocab.mean, age) {
  return(coef(lm(pos.prop ~ I((vocab.mean*100)^2) + I(vocab.mean*100) * age + 0))["I(vocab.mean * 100):age"])
  }

linear.mod.se.fun <- function(pos.prop, vocab.mean, age) {
  return(summary(lm(pos.prop ~ I((vocab.mean*100)^2) + I(vocab.mean*100) * age + 0))$coefficients["I(vocab.mean * 100):age", "Std. Error"])
  }

noun.verb.coefs <- prop.noun.verb %>%
  group_by(language, pos) %>%
  summarise(coef = mod.coef.fun(pos.prop, vocab.mean, age),
            se = mod.se.fun(pos.prop, vocab.mean, age))
```

```{r}
quartz(width=6, height=4)
ggplot(noun.verb.coefs, 
       aes(x=language, y=coef, fill=pos)) + 
  geom_bar(position="dodge", stat="identity") + 
  geom_linerange(aes(ymin=coef-se, ymax=coef+se), 
                 position = position_dodge(width=.9)) +
  ylab("Age interaction coefficient") + 
  xlab("Language") +
  theme_bw(base_size = 14) +
  scale_fill_brewer(palette = "Set1",
                    name = "") +
  theme(legend.position = c(0.07,0.95),
        legend.text = element_text(size=10),
        legend.key.height = unit(0.9, "char"),
        legend.key.width = unit(0.4, "cm"),
        legend.key = element_blank(),
        legend.background = element_rect(fill="transparent"))
ggsave(file=("~/Documents/projects/cdi-grammar/cogsci_paper/plots/coefs_noun_verb.png"), width=6, height=4)
```